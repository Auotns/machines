import{Oa as E,Ua as N,Va as r,Wa as O,b as m,c as u,f as v,g as $,i as f,j as y,l as g,o as T,r as _,x as M}from"./chunk-7UP7YQVV.js";import{a as k,b as S}from"./chunk-K5CSBBV3.js";var D=[{id:"cnc-001",name:"CNC Mill",type:"Machining",location:"Shop Floor A",status:"operational",lastMaintenance:"2024-06-15",nextMaintenance:"2024-09-15",manualUrl:"#",downtime:10.5,lastStatusChange:"2024-07-20T10:00:00Z"},{id:"lathe-002",name:"Industrial Lathe",type:"Machining",location:"Shop Floor A",status:"maintenance",lastMaintenance:"2024-07-20",nextMaintenance:"2024-07-28",manualUrl:"#",downtime:25.2,lastStatusChange:"2024-07-22T08:30:00Z"},{id:"press-003",name:"Hydraulic Press",type:"Fabrication",location:"Shop Floor B",status:"operational",lastMaintenance:"2024-05-10",nextMaintenance:"2024-11-10",manualUrl:"#",downtime:5,lastStatusChange:"2024-06-01T14:00:00Z"},{id:"robot-004",name:"Welding Robot Arm",type:"Automation",location:"Assembly Line 1",status:"offline",lastMaintenance:"2024-01-05",nextMaintenance:"2025-01-05",manualUrl:"#",downtime:120.7,lastStatusChange:"2024-07-15T16:45:00Z"}],U=[{id:"sp-001",name:"Spindle Bearing",sku:"BRG-5021",quantity:15,minQuantity:10,location:"Bin A-12"},{id:"sp-002",name:"Motor Coolant Pump",sku:"PMP-C-34",quantity:4,minQuantity:5,location:"Bin B-05"},{id:"sp-003",name:"Hydraulic Fluid Filter",sku:"FIL-H-99",quantity:45,minQuantity:20,location:"Bin A-15"},{id:"sp-004",name:"Servo Motor",sku:"MOT-S-850",quantity:8,minQuantity:10,location:"Bin C-01"}],x=[{id:"log-001",deviceId:"cnc-001",deviceName:"CNC Mill",date:"2024-06-15",technician:"admin@example.com",notes:"Replaced spindle bearing, checked coolant levels.",type:"scheduled",durationMinutes:120},{id:"log-002",deviceId:"press-003",deviceName:"Hydraulic Press",date:"2024-05-10",technician:"technician@example.com",notes:"Annual fluid change and filter replacement.",type:"scheduled",durationMinutes:90},{id:"log-003",deviceId:"lathe-002",deviceName:"Industrial Lathe",date:"2024-07-20",technician:"admin@example.com",notes:"Emergency repair on the drive belt.",type:"emergency",durationMinutes:45}],w=class w{constructor(){this.apiService=_(N);this.supabaseService=_(O);this.router=_(E);this.devices=M(D);this.parts=M(U);this.logs=M(x)}getValidToken(){let e=localStorage.getItem("supabase.auth.token");if(!e)return console.warn("\u26A0\uFE0F No auth token found"),null;try{let n=JSON.parse(e),t=n.expires_at;return t&&t*1e3<Date.now()+6e4?(console.warn("\u26A0\uFE0F Token expired, clearing and redirecting to login"),localStorage.removeItem("supabase.auth.token"),setTimeout(()=>{alert("Va\u0161e prihl\xE1senie vypr\u0161alo. Pros\xEDm prihl\xE1ste sa znova."),this.router.navigate(["/login"])},100),null):n.access_token}catch(n){return console.error("\u274C Error parsing token:",n),null}}getDevicesSignal(){return this.devices.asReadonly()}loadDevices(){if(console.log("\u{1F50D} DataService.loadDevices() called"),console.log("enableMockData:",r.enableMockData),r.enableMockData)return u(D).pipe(y(300),g(n=>this.devices.set(n)));console.log("\u{1F4E1} Fetching devices from Supabase via direct fetch...");let e=this.getValidToken();return e?m(fetch(`${r.supabase.url}/rest/v1/devices?order=created_at.desc`,{headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}).then(n=>{if(console.log("\u{1F4E5} Fetch response status:",n.status),!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()})).pipe(g(n=>console.log("\u2705 Supabase returned data:",n)),v(n=>{let t=n.map(this.mapDeviceFromDb);return console.log("\u2705 Mapped devices:",t),t}),g(n=>{console.log("\u{1F4DD} Setting devices signal with:",n),this.devices.set(n)}),f(n=>(console.error("\u274C Error loading devices:",n),this.devices.set(D),u(D)))):(console.warn("\u26A0\uFE0F No valid auth token found, using mock data"),this.devices.set(D),u(D))}mapDeviceFromDb(e){return{id:e.id,name:e.name,type:e.type,manufacturer:e.manufacturer,location:e.location,status:e.status,imageUrl:e.image_url,manualUrl:e.manual_url,lastMaintenance:e.last_maintenance,nextMaintenance:e.next_maintenance,maintenancePeriod:e.maintenance_period,specifications:e.specifications,downtime:e.downtime,lastStatusChange:e.last_status_change,electricalInspectionDate:e.electrical_inspection_date,electricalInspectionPeriod:e.electrical_inspection_period,electricalInspectionExpiry:e.electrical_inspection_expiry}}addDevice(e){if(r.enableMockData){let t=S(k({},e),{id:e.id||`device-${Date.now()}`});return this.devices.update(a=>[t,...a]),u(t).pipe(y(300))}console.log("\u{1F4E4} Adding new device via direct fetch:",e);let n=this.getValidToken();if(!n)throw console.warn("\u26A0\uFE0F No valid auth token found"),new Error("Va\u0161e prihl\xE1senie vypr\u0161alo. Pros\xEDm prihl\xE1ste sa znova.");return m(fetch(`${r.supabase.url}/rest/v1/devices`,{method:"POST",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${n}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify({id:e.id,name:e.name,type:e.type,manufacturer:e.manufacturer||null,location:e.location,status:e.status,image_url:e.imageUrl||null,manual_url:e.manualUrl||null,last_maintenance:e.lastMaintenance,next_maintenance:e.nextMaintenance,maintenance_period:e.maintenancePeriod||null,specifications:e.specifications||null,electrical_inspection_date:e.electricalInspectionDate||null,electrical_inspection_period:e.electricalInspectionPeriod||null,electrical_inspection_expiry:e.electricalInspectionExpiry||null,downtime:e.downtime,last_status_change:e.lastStatusChange})}).then(async t=>{console.log("\u{1F4E5} Add device response status:",t.status);let a=await t.text();if(console.log("\u{1F4E5} Response body:",a),!t.ok)throw console.error("\u274C Server error response:",a),new Error(`HTTP ${t.status}: ${a}`);return a?JSON.parse(a):null})).pipe(g(t=>console.log("\u2705 Device added:",t)),v(t=>{if(t&&t.length>0)return this.mapDeviceFromDb(t[0]);throw new Error("No data returned")}),g(t=>{console.log("\u{1F4DD} Updating local devices signal"),this.devices.update(a=>[t,...a])}),f(t=>{throw console.error("\u274C Error adding device:",t),t}))}getDeviceById(e){if(r.enableMockData){let n=this.devices().find(t=>t.id===e);return u(n).pipe(y(200))}return m(this.supabaseService.db.from("devices").select("*").eq("id",e).single()).pipe(v(({data:n,error:t})=>{if(t)throw t;return n?this.mapDeviceFromDb(n):void 0}),f(n=>{console.error("Error loading device:",n);let t=this.devices().find(a=>a.id===e);return u(t)}))}updateDeviceStatus(e,n){let t=()=>{this.devices.update(o=>o.map(s=>{if(s.id===e&&s.status!==n){let p=new Date,b=s.downtime;if((s.status==="maintenance"||s.status==="offline")&&n==="operational"){let C=new Date(s.lastStatusChange),F=(p.getTime()-C.getTime())/(1e3*60*60);b+=F}return S(k({},s),{status:n,downtime:parseFloat(b.toFixed(2)),lastStatusChange:p.toISOString()})}return s}))};if(r.enableMockData){t();let o=this.devices().find(s=>s.id===e);return u(o).pipe(y(300))}console.log("\u{1F504} Updating device status via direct fetch...");let a=localStorage.getItem("supabase.auth.token");if(!a){console.warn("\u26A0\uFE0F No auth token found"),t();let o=this.devices().find(s=>s.id===e);return u(o)}let i=JSON.parse(a),h=this.devices().find(o=>o.id===e);if(!h)return console.error("\u274C Device not found:",e),u(null);let l=new Date,c=h.downtime;if((h.status==="maintenance"||h.status==="offline")&&n==="operational"){let o=new Date(h.lastStatusChange),p=(l.getTime()-o.getTime())/(1e3*60*60);c+=p}let d={status:n,downtime:parseFloat(c.toFixed(2)),last_status_change:l.toISOString()};return console.log("\u{1F4E4} Sending update:",d),m(fetch(`${r.supabase.url}/rest/v1/devices?id=eq.${e}`,{method:"PATCH",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${i.access_token}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify(d)}).then(o=>{if(console.log("\u{1F4E5} Update response status:",o.status),!o.ok)throw new Error(`HTTP ${o.status}`);return o.json()})).pipe(g(o=>console.log("\u2705 Update response:",o)),v(o=>o&&o.length>0?this.mapDeviceFromDb(o[0]):S(k({},h),{status:n,downtime:parseFloat(c.toFixed(2)),lastStatusChange:l.toISOString()})),g(o=>{console.log("\u{1F4DD} Updating local devices signal"),this.devices.update(s=>s.map(p=>p.id===e?o:p))}),f(o=>{console.error("\u274C Error updating device status:",o),t();let s=this.devices().find(p=>p.id===e);return u(s)}))}updateElectricalInspection(e,n,t){let a=new Date(n),i=new Date(a);i.setFullYear(i.getFullYear()+t);let h=i.toISOString().split("T")[0],l=()=>{this.devices.update(s=>s.map(p=>p.id===e?S(k({},p),{electricalInspectionDate:n,electricalInspectionPeriod:t,electricalInspectionExpiry:h}):p))};if(r.enableMockData){l();let s=this.devices().find(p=>p.id===e);return u(s).pipe(y(300))}console.log("\u{1F504} Updating electrical inspection via direct fetch...");let c=localStorage.getItem("supabase.auth.token");if(!c){console.warn("\u26A0\uFE0F No auth token found"),l();let s=this.devices().find(p=>p.id===e);return u(s)}let d=JSON.parse(c),o={electrical_inspection_date:n,electrical_inspection_period:t,electrical_inspection_expiry:h};return console.log("\u{1F4E4} Sending inspection update:",o),m(fetch(`${r.supabase.url}/rest/v1/devices?id=eq.${e}`,{method:"PATCH",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${d.access_token}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify(o)}).then(s=>{if(console.log("\u{1F4E5} Inspection update response status:",s.status),!s.ok)throw new Error(`HTTP ${s.status}`);return s.json()})).pipe(g(s=>console.log("\u2705 Inspection update response:",s)),v(s=>{if(s&&s.length>0)return this.mapDeviceFromDb(s[0]);let p=this.devices().find(b=>b.id===e);return S(k({},p),{electricalInspectionDate:n,electricalInspectionPeriod:t,electricalInspectionExpiry:h})}),g(s=>{console.log("\u{1F4DD} Updating local devices signal with inspection data"),this.devices.update(p=>p.map(b=>b.id===e?s:b))}),f(s=>{console.error("\u274C Error updating electrical inspection:",s),l();let p=this.devices().find(b=>b.id===e);return u(p)}))}deleteDevice(e){if(r.enableMockData)return this.devices.update(a=>a.filter(i=>i.id!==e)),u(void 0).pipe(y(300));console.log("\u{1F5D1}\uFE0F Deleting device via direct fetch:",e);let n=localStorage.getItem("supabase.auth.token");if(!n)return console.warn("\u26A0\uFE0F No auth token found"),u(void 0);let t=JSON.parse(n);return m(fetch(`${r.supabase.url}/rest/v1/devices?id=eq.${e}`,{method:"DELETE",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"}}).then(a=>{if(console.log("\u{1F4E5} Delete response status:",a.status),!a.ok)throw new Error(`HTTP ${a.status}`)})).pipe(g(()=>console.log("\u2705 Device deleted from database")),g(()=>{console.log("\u{1F4DD} Removing device from local signal"),this.devices.update(a=>a.filter(i=>i.id!==e))}),v(()=>{}),f(a=>{throw console.error("\u274C Error deleting device:",a),a}))}deletePart(e){if(r.enableMockData)return this.parts.update(a=>a.filter(i=>i.id!==e)),u(void 0).pipe(y(300));console.log("\u{1F5D1}\uFE0F Deleting spare part via direct fetch:",e);let n=localStorage.getItem("supabase.auth.token");if(!n)return console.warn("\u26A0\uFE0F No auth token found"),u(void 0);let t=JSON.parse(n);return m(fetch(`${r.supabase.url}/rest/v1/spare_parts?id=eq.${e}`,{method:"DELETE",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"}}).then(a=>{if(console.log("\u{1F4E5} Delete part response status:",a.status),!a.ok)throw new Error(`HTTP ${a.status}`)})).pipe(g(()=>console.log("\u2705 Spare part deleted from database")),g(()=>{console.log("\u{1F4DD} Removing part from local signal"),this.parts.update(a=>a.filter(i=>i.id!==e))}),v(()=>{}),f(a=>{throw console.error("\u274C Error deleting spare part:",a),a}))}uploadDeviceManual(e,n){if(r.enableMockData)return u("mock-manual-url").pipe(y(500));console.log("\u{1F4E4} Uploading manual for device:",e,"File:",n.name);let t=localStorage.getItem("supabase.auth.token");if(!t)throw console.warn("\u26A0\uFE0F No auth token found"),new Error("Authentication required");let a=JSON.parse(t),h=`manuals/${`${e}_${Date.now()}.pdf`}`;return m(fetch(`${r.supabase.url}/storage/v1/object/device-manuals/${h}`,{method:"POST",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${a.access_token}`,"Content-Type":n.type},body:n}).then(async l=>{console.log("\u{1F4E5} Upload response status:",l.status);let c=await l.text();if(console.log("\u{1F4E5} Upload response:",c),!l.ok)throw new Error(`Upload failed: ${l.status} - ${c}`);let d=`${r.supabase.url}/storage/v1/object/public/device-manuals/${h}`;return console.log("\u2705 Manual uploaded, public URL:",d),fetch(`${r.supabase.url}/rest/v1/devices?id=eq.${e}`,{method:"PATCH",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${a.access_token}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify({manual_url:d})})}).then(async l=>{if(!l.ok)throw new Error(`Failed to update device: ${l.status}`);let c=await l.json();if(console.log("\u2705 Device updated with manual URL"),c&&c.length>0){let d=this.mapDeviceFromDb(c[0]);this.devices.update(o=>o.map(s=>s.id===e?d:s))}return c[0].manual_url})).pipe(f(l=>{throw console.error("\u274C Error uploading manual:",l),l}))}uploadDeviceImage(e,n){if(r.enableMockData)return u("mock-image-url").pipe(y(500));console.log("\u{1F4E4} Uploading image for device:",e,"File:",n.name);let t=localStorage.getItem("supabase.auth.token");if(!t)throw console.warn("\u26A0\uFE0F No auth token found"),new Error("Authentication required");let a=JSON.parse(t),i=n.name.split(".").pop(),l=`images/${`${e}_${Date.now()}.${i}`}`;return m(fetch(`${r.supabase.url}/storage/v1/object/device-manuals/${l}`,{method:"POST",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${a.access_token}`,"Content-Type":n.type},body:n}).then(async c=>{console.log("\u{1F4E5} Upload image response status:",c.status);let d=await c.text();if(console.log("\u{1F4E5} Upload image response:",d),!c.ok)throw new Error(`Upload failed: ${c.status} - ${d}`);let o=`${r.supabase.url}/storage/v1/object/public/device-manuals/${l}`;return console.log("\u2705 Image uploaded, public URL:",o),fetch(`${r.supabase.url}/rest/v1/devices?id=eq.${e}`,{method:"PATCH",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${a.access_token}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify({image_url:o})})}).then(async c=>{if(!c.ok)throw new Error(`Failed to update device: ${c.status}`);let d=await c.json();if(console.log("\u2705 Device updated with image URL"),d&&d.length>0){let o=this.mapDeviceFromDb(d[0]);this.devices.update(s=>s.map(p=>p.id===e?o:p))}return d[0].image_url})).pipe(f(c=>{throw console.error("\u274C Error uploading image:",c),c}))}getPartsSignal(){return this.parts.asReadonly()}getParts(){if(r.enableMockData)return u(this.parts()).pipe(y(300));console.log("\u{1F4E1} Fetching spare parts from Supabase...");let e=localStorage.getItem("supabase.auth.token");if(!e)return console.warn("\u26A0\uFE0F No auth token found for parts"),u(this.parts());let n=JSON.parse(e);return m(fetch(`${r.supabase.url}/rest/v1/spare_parts?select=*,devices:device_id(name,type)&order=created_at.desc`,{headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${n.access_token}`,"Content-Type":"application/json"}}).then(t=>t.json())).pipe(g(t=>console.log("\u2705 Parts data:",t)),v(t=>(t||[]).map(a=>this.mapPartFromDb(a))),g(t=>this.parts.set(t)),f(t=>(console.error("\u274C Error loading parts:",t),u(this.parts()))))}mapPartFromDb(e){return{id:e.id,name:e.name,sku:e.sku,quantity:e.quantity,minQuantity:e.min_quantity||10,location:e.location,deviceId:e.device_id||void 0,deviceName:e.devices?.name||e.device_name||void 0,deviceType:e.devices?.type||void 0}}updatePartQuantity(e,n,t,a="set"){if(r.enableMockData){this.parts.update(c=>c.map(d=>d.id===e?S(k({},d),{quantity:n}):d));let l=this.parts().find(c=>c.id===e);return u(l).pipe(y(300))}console.log("\u{1F504} Updating part quantity via Supabase client:",{partId:e,newQuantity:n,notes:t,changeType:a});let i=this.parts().find(l=>l.id===e);if(!i)return console.error("\u274C Part not found:",e),u(null);let h=i.quantity;return console.log("\u{1F680} Starting update process..."),$(()=>{console.log("\u{1F3AF} Observable subscribed!");let l=this.supabaseService.auth.getSession().then(async({data:{session:c},error:d})=>{if(console.log("\u{1F510} Current session before update:",c?"EXISTS":"NULL",d),!c){console.log("\u26A0\uFE0F No session, attempting to restore from localStorage...");let o=localStorage.getItem("supabase.auth.token");if(o)try{let s=JSON.parse(o);console.log("\u{1F4E6} Found stored tokens, setting session...");let{data:p,error:b}=await this.supabaseService.auth.setSession({access_token:s.access_token,refresh_token:s.refresh_token});if(b||!p.session)throw console.error("\u274C Failed to restore session from tokens:",b),new Error("Session restore failed: "+(b?.message||"No session"));console.log("\u2705 Session restored successfully"),c=p.session}catch(s){throw console.error("\u274C Error restoring session:",s),new Error("Session error: "+s.message)}else throw console.error("\u274C No stored tokens found"),new Error("No stored session - please login")}return console.log("\u{1F504} Executing UPDATE query..."),this.supabaseService.db.from("spare_parts").update({quantity:n}).eq("id",e).select().then(o=>{if(console.log("\u{1F4E5} Update part response:",o),console.log("\u{1F4E5} Response status:",o.status),console.log("\u{1F4E5} Response error:",o.error),console.log("\u{1F4E5} Response data:",o.data),o.error)throw console.error("\u274C Supabase error:",o.error),new Error(o.error.message);if(!o.data||o.data.length===0)throw console.error("\u274C No data returned from update - RLS policy may be blocking"),new Error("Update blocked - check RLS policies in Supabase");return o.data})}).catch(c=>{throw console.error("\u274C Promise chain error:",c),c});return m(l)}).pipe(g(l=>console.log("\u2705 Part quantity updated:",l)),v(l=>this.mapPartFromDb(l[0])),g(l=>{console.log("\u{1F4DD} Updating local parts signal"),this.parts.update(o=>o.map(s=>s.id===e?l:s));let c=localStorage.getItem("currentUser"),d=c?JSON.parse(c).email:"unknown";console.log("\u{1F4DD} Creating history record with user:",d),this.supabaseService.db.from("spare_parts_history").insert({part_id:e,part_name:i.name,quantity_before:h,quantity_after:n,change_type:a,notes:t||null,changed_by:d}).then(o=>{o.error?console.warn("\u26A0\uFE0F Failed to create history record:",o.error):console.log("\u2705 History record created")},o=>console.warn("\u26A0\uFE0F History save error:",o))}),f(l=>{throw console.error("\u274C Error updating part quantity:",l),l}))}getPartLastChange(e){if(r.enableMockData)return u(null);let n=localStorage.getItem("supabase.auth.token");if(!n)return u(null);let t=JSON.parse(n);return m(fetch(`${r.supabase.url}/rest/v1/spare_parts_history?part_id=eq.${e}&order=created_at.desc&limit=1`,{headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"}}).then(a=>a.json())).pipe(v(a=>a&&a.length>0?a[0]:null),f(()=>u(null)))}addPart(e){if(r.enableMockData){let a=S(k({},e),{id:`sp-${Date.now()}`});return this.parts.update(i=>[a,...i]),u(a).pipe(y(300))}console.log("\u{1F4E4} Adding new part via direct fetch:",e);let n=localStorage.getItem("supabase.auth.token");if(!n)return console.warn("\u26A0\uFE0F No auth token found"),u(null);let t=JSON.parse(n);return m(fetch(`${r.supabase.url}/rest/v1/spare_parts`,{method:"POST",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify({name:e.name,sku:e.sku,quantity:e.quantity,min_quantity:e.minQuantity||10,location:e.location,device_id:e.deviceId||null,device_name:e.deviceName||null})}).then(async a=>{console.log("\u{1F4E5} Add part response status:",a.status);let i=await a.text();if(console.log("\u{1F4E5} Response body:",i),!a.ok){console.error("\u274C Server error response:",i);try{let h=JSON.parse(i);if(h.code==="23505"&&h.message?.includes("spare_parts_sku_key"))throw new Error("SKU u\u017E existuje. Pou\u017Eite in\xE9 SKU pre tento diel.")}catch{}throw new Error(`HTTP ${a.status}: ${i}`)}return i?JSON.parse(i):null})).pipe(g(a=>console.log("\u2705 Part added:",a)),v(a=>{if(a&&a.length>0)return this.mapPartFromDb(a[0]);throw new Error("No data returned")}),g(a=>{console.log("\u{1F4DD} Updating local parts signal"),this.parts.update(i=>[a,...i])}),f(a=>{throw console.error("\u274C Error adding part:",a),a}))}getMaintenanceLogsSignal(){return this.logs.asReadonly()}getMaintenanceLogs(){if(r.enableMockData)return u(this.logs()).pipe(y(300));console.log("\u{1F4E1} Fetching maintenance logs from Supabase...");let e=localStorage.getItem("supabase.auth.token");if(!e)return console.warn("\u26A0\uFE0F No auth token found for logs"),u(this.logs());let n=JSON.parse(e);return m(fetch(`${r.supabase.url}/rest/v1/maintenance_logs?order=created_at.desc`,{headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${n.access_token}`,"Content-Type":"application/json"}}).then(t=>t.json())).pipe(g(t=>console.log("\u2705 Logs data:",t)),v(t=>(t||[]).map(this.mapLogFromDb)),g(t=>this.logs.set(t)),f(t=>(console.error("\u274C Error loading logs:",t),u(this.logs()))))}mapLogFromDb(e){return{id:e.id,deviceId:e.device_id,deviceName:e.device_name,date:e.date,technician:e.technician,notes:e.notes,type:e.type,durationMinutes:e.duration_minutes||0}}addMaintenanceLog(e){let n=()=>{let t=S(k({},e),{id:`log-${Date.now()}`});return this.logs.update(a=>[t,...a]),this.devices.update(a=>a.map(i=>i.id===e.deviceId?S(k({},i),{lastMaintenance:new Date().toISOString().split("T")[0]}):i)),t};if(r.enableMockData){let t=n();return u(t).pipe(y(500))}return m(this.supabaseService.db.from("maintenance_logs").insert({device_id:e.deviceId,device_name:e.deviceName,date:e.date,technician:e.technician,notes:e.notes,type:e.type,duration_minutes:e.durationMinutes}).select().single()).pipe(v(({data:t,error:a})=>{if(a)throw a;return this.mapLogFromDb(t)}),g(t=>{this.logs.update(a=>[t,...a]),m(this.supabaseService.db.from("devices").update({last_maintenance:new Date().toISOString().split("T")[0]}).eq("id",e.deviceId)).subscribe(),this.devices.update(a=>a.map(i=>i.id===e.deviceId?S(k({},i),{lastMaintenance:new Date().toISOString().split("T")[0]}):i))}),f(t=>{console.error("Error adding maintenance log:",t);let a=n();return u(a)}))}deleteMaintenanceLog(e){console.log("\u{1F5D1}\uFE0F DataService.deleteMaintenanceLog() called for:",e);let n=()=>{this.logs.update(i=>i.filter(h=>h.id!==e))};if(r.enableMockData)return n(),u(void 0).pipe(y(300));let t=localStorage.getItem("supabase.auth.token");if(!t)return console.warn("\u26A0\uFE0F No auth token found"),u(void 0);let a=JSON.parse(t);return m(fetch(`${r.supabase.url}/rest/v1/maintenance_logs?id=eq.${e}`,{method:"DELETE",headers:{apikey:r.supabase.anonKey,Authorization:`Bearer ${a.access_token}`,"Content-Type":"application/json"}}).then(i=>{if(console.log("\u{1F4E5} Delete response status:",i.status),!i.ok)throw new Error(`HTTP ${i.status}`)})).pipe(g(()=>{console.log("\u2705 Maintenance log deleted from Supabase"),n()}),v(()=>{}),f(i=>{throw console.error("\u274C Error deleting maintenance log:",i),i}))}};w.\u0275fac=function(n){return new(n||w)},w.\u0275prov=T({token:w,factory:w.\u0275fac,providedIn:"root"});var P=w;export{P as a};
