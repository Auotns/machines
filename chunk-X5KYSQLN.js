import{D as U,Na as k,Ta as v,Ua as a,Va as y,b as h,c as i,f,h as p,k as d,n as b,q as g,w as S}from"./chunk-YQ2LVPI6.js";var l=class l{constructor(){this.apiService=g(v);this.supabaseService=g(y);this.router=g(k);this.ngZone=g(U);this.currentUser=S(null);this.initializeAuth(),this.setupAuthListener()}async initializeAuth(){if(a.enableMockData){let e=localStorage.getItem("currentUser");if(e)try{this.currentUser.set(JSON.parse(e))}catch(r){console.error("Error parsing stored user:",r),this.clearAuthData()}return}try{let{data:{session:e}}=await this.supabaseService.auth.getSession();if(console.log("Session on init:",e),e?.user)console.log("User found in session, loading profile..."),await this.loadUserProfile(e.user.id);else{console.log("No active session, checking localStorage...");let r=localStorage.getItem("currentUser");if(r)try{let o=JSON.parse(r);this.currentUser.set(o),console.log("User restored from localStorage:",o)}catch(o){console.error("Error parsing stored user:",o),this.clearAuthData()}}}catch(e){console.error("Error initializing auth:",e);let r=localStorage.getItem("currentUser");if(r)try{this.currentUser.set(JSON.parse(r))}catch{this.clearAuthData()}}}setupAuthListener(){a.enableMockData||this.supabaseService.auth.onAuthStateChange(async(e,r)=>{e==="SIGNED_IN"&&r?.user?await this.loadUserProfile(r.user.id):e==="SIGNED_OUT"&&this.currentUser.set(null)})}async loadUserProfile(e){try{let{data:r,error:o}=await this.supabaseService.db.from("users").select("*").eq("id",e).single();if(o)throw o;if(r){let t={id:r.id,email:r.email,role:r.role};this.currentUser.set(t),localStorage.setItem("currentUser",JSON.stringify(t))}}catch(r){console.error("Error loading user profile:",r)}}loginWithEmail(e,r){if(console.log("loginWithEmail() called with email:",e),console.log("enableMockData:",a.enableMockData),a.enableMockData){console.log("Using mock login");let o=e.includes("admin")?"admin":"technician";return this.mockLogin(o)}return this.performSupabaseLogin(e,r)}login(e,r){if(console.log("login() called with role:",e),console.log("enableMockData:",a.enableMockData),a.enableMockData)return console.log("Using mock login"),this.mockLogin(e);let o=`${e}@example.com`,t=r||"password123";return this.performSupabaseLogin(o,t)}performSupabaseLogin(e,r){console.log("Attempting Supabase login with email:",e);let o=fetch(`${a.supabase.url}/auth/v1/token?grant_type=password`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a.supabase.anonKey},body:JSON.stringify({email:e,password:r})}).then(async t=>{console.log("Supabase API response:",t.status);let s=await t.json();if(!t.ok)throw new Error(s.error_description||s.msg||"Login failed");console.log("Login successful, user:",s.user),console.log("Storing tokens in localStorage..."),localStorage.setItem("supabase.auth.token",JSON.stringify({access_token:s.access_token,refresh_token:s.refresh_token,expires_at:s.expires_at})),console.log("Loading user profile for ID:",s.user.id);try{let c=await(await fetch(`${a.supabase.url}/rest/v1/users?id=eq.${s.user.id}`,{headers:{apikey:a.supabase.anonKey,Authorization:`Bearer ${s.access_token}`}})).json();if(console.log("Profile response:",c),c&&c.length>0){let n=c[0],u={id:n.id,email:n.email,role:n.role};this.currentUser.set(u),localStorage.setItem("currentUser",JSON.stringify(u)),console.log("User profile loaded:",u)}else{console.warn("No profile found, using data from auth user_metadata");let n=s.user.user_metadata?.role||s.user.raw_user_meta_data?.role||"technician",u={id:s.user.id,email:s.user.email,role:n};this.currentUser.set(u),localStorage.setItem("currentUser",JSON.stringify(u))}}catch(m){console.error("Error loading user profile:",m);let c=s.user.user_metadata?.role||s.user.raw_user_meta_data?.role||"technician",n={id:s.user.id,email:s.user.email,role:c};this.currentUser.set(n),localStorage.setItem("currentUser",JSON.stringify(n))}return!0}).catch(t=>{throw console.error("Login error:",t),t});return h(o).pipe(d(t=>{t&&(console.log("Login successful, navigating to dashboard..."),console.log("Current user:",this.currentUser()),this.ngZone.run(()=>{this.router.navigate(["/dashboard"]).then(()=>{console.log("Navigation completed")})}))}),p(t=>(console.error("Login catchError:",t),i(!1))))}signUp(e,r,o){return a.enableMockData?i(!1):h(this.supabaseService.auth.signUp({email:e,password:r})).pipe(d(async({data:t,error:s})=>{if(s)throw s;t.user&&(await this.supabaseService.db.from("users").insert({id:t.user.id,email:t.user.email,role:o}),await this.loadUserProfile(t.user.id))}),f(({error:t})=>!t),p(t=>(console.error("Sign up error:",t),i(!1))))}mockLogin(e){let r={id:e==="admin"?"1":"2",email:`${e}@example.com`,role:e},o=this.generateMockToken(r);return this.currentUser.set(r),localStorage.setItem("currentUser",JSON.stringify(r)),localStorage.setItem(a.jwtTokenKey,o),this.router.navigateByUrl("/dashboard"),i(!0)}logout(){if(console.log("\u{1F6AA} Logging out..."),a.enableMockData)return this.clearAuthData(),i(void 0);let e=localStorage.getItem("supabase.auth.token");if(!e)return console.log("No token found, clearing auth data"),this.clearAuthData(),i(void 0);let r=JSON.parse(e);return h(fetch(`${a.supabase.url}/auth/v1/logout`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a.supabase.anonKey,Authorization:`Bearer ${r.access_token}`}}).then(o=>{console.log("\u{1F4E5} Logout response status:",o.status),o.status===204||o.ok?console.log("\u2705 Successfully logged out from Supabase"):console.warn("\u26A0\uFE0F Logout returned non-success status, but will clear local data anyway")}).catch(o=>{console.error("\u274C Logout error:",o)})).pipe(d(()=>this.clearAuthData()),f(()=>{}),p(()=>(this.clearAuthData(),i(void 0))))}clearAuthData(){console.log("\u{1F9F9} Clearing auth data"),this.currentUser.set(null),localStorage.removeItem("currentUser"),localStorage.removeItem("supabase.auth.token"),console.log("\u27A1\uFE0F Redirecting to login"),this.router.navigateByUrl("/login")}generateMockToken(e){let r=btoa(JSON.stringify({alg:"HS256",typ:"JWT"})),o=btoa(JSON.stringify({sub:e.id,email:e.email,role:e.role,iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+1440*60})),t=btoa("mock-signature");return`${r}.${o}.${t}`}isAdmin(){return this.currentUser()?.role==="admin"}async isAuthenticated(){if(a.enableMockData)return!!this.currentUser();let{data:e}=await this.supabaseService.auth.getSession();return!!e.session}};l.\u0275fac=function(r){return new(r||l)},l.\u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"});var w=l;export{w as a};
